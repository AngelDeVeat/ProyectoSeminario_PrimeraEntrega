@page "/Persona/{id:int?}"
@rendermode InteractiveServer
@inject NavigationManager Navegador;
@inject PersonaAltaUseCase PersonaAltaUseCase
@inject PersonaModificacionUseCase PersonaModificacionUseCase
@inject PersonaModificacionUseCase PersonaModificacionUseCase
@inject ObtenerPersonaUseCase ObtenerPersonaUseCase
@inject UserState User
@*SI el usuario llego hasta aqui sin pasar por inicio_sesion/registro*@
<Mensaje @ref=dialogo 
mensaje="Acceso no autorizado" 
soloMensaje=true
OnCerrado="VolverHome"/>
<DialogoEx  @ref="dialogoex"/>
@if (_esnuevapersona)
 {
<h3>Agregando un nueva Persona</h3>
 }
 else
{
<h3> Modificando a la Persona "@persona.Nombre"</h3>
 }
<input placeholder="DNI" @bind="persona.DNI" class="form-control">
<input placeholder="Nombre" @bind="persona.Nombre" class="form-control">
<input placeholder="Apellido" @bind="persona.Apellido" class="form-control">
<input placeholder="Correo Electronico" @bind="persona.Email" class="form-control">
<input placeholder="Telefono" @bind="persona.Telefono" class="form-control">
<button class="btn btn-primary" @onclick="Aceptar">Aceptar</button>
<button class="btn btn-danger" @onclick="()=>VolverInicio()">
            Volver al inicio
        </button>
@code {
Persona persona = new Persona();
Mensaje? dialogo=null;
[Parameter] public int? id{get;set;}
bool _esnuevapersona=true;
DialogoEx? dialogoex;
Usuario? user{get; set;}=null;
bool mostrarDialogo= false;
protected override void OnInitialized(){
  user=User.user;
  if (user ==null){
    mostrarDialogo=true;
  }
}
protected override void OnParametersSet()
{
if (id != null)
{
  var _persona = ObtenerPersonaUseCase.Ejecutar(id.Value);
  if (_persona != null){
      persona=_persona;
      _esnuevapersona=false;
   }
}
}
private void VolverInicio(){
     Navegador.NavigateTo($"inicio");
}
private void VolverHome(){
     Navegador.NavigateTo($"");
}
void Aceptar()
{
  try{
  if (user!=null){
      if (_esnuevapersona)
       PersonaAltaUseCase.Alta(persona, user);
    else
       PersonaModificacionUseCase.Modificacion(persona,user);
   }
persona = new Persona();
Navegador.NavigateTo("listadoPersonas");
}
 catch(Exception e){
    dialogoex?.Mostrar(e.Message);
 }}

 protected override Task OnAfterRenderAsync(bool firstRender){
        if (mostrarDialogo && dialogo != null && firstRender){
            dialogo.Mostrar();
            mostrarDialogo = false;
            StateHasChanged();
        }
        return Task.CompletedTask;
    } 
}